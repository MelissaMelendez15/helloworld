pipeline {
    agent none

    stages {
        stage('Clonar repositorio') {
            agent { label 'agente-clonador' }
            steps {
                sh 'whoami && hostname && pwd'
                git branch: 'master', url: 'https://github.com/MelissaMelendez15/helloworld.git'
                sh'ls -l'
                stash includes: '**', name: 'workspace-clonado'
                echo 'Repositorio Clonado y guardado.'
            }
        }

        stage('Instalar dependencias') {
            agent { label 'agente-build' }
            steps {
                sh 'whoami && hostname && pwd'
                unstash 'workspace-clonado'
                sh 'ls -l app/'
                sh 'pip3 install flask pytest requests --break-system-packages'
                echo 'Dependencias instaladas correctamente'
            }
        }

        stage('Build') {
            agent { label 'agente-build' }
            steps {
                sh 'whoami && hostname && pwd'
                unstash 'workspace-clonado'
                echo 'Build: Verificando archivos clonados...'
                sh 'ls -l app/'
                stash includes: '**', name: 'workspace-build'
                echo 'Build completado y guardado'
            }
        }

        stage('Iniciar Flask') {
            agent { label 'agente-deploy' }
            steps {
                sh 'whoami && hostname && pwd'
                unstash 'workspace-build'
                echo 'Inciando Flask...'
                sh '''
                   nohup python3 app/api.py > flask.log 2>&1 &
                   sleep 5
                   if curl -s http://localhost:5000; then
                echo "Flask iniciado correctamente."
                else
                   echo "Error: Flask no inició correctamente..."
                   cat flask.log
                   exit 1
                fi
            '''
            }
        }

        stage('Iniciar Wiremock') {
            agent { label 'agente-deploy' }
            steps {
               sh 'whoami && hostname && pwd'
               unstash 'workspace-build'
               echo 'Iniciando Wiremock...'
               sh '''
                  nohup java -jar test/wiremock/wiremock-standalone-2.27.2.jar --port 9090 --root-dir test/wiremock > wiremock.log 2>&1 &
                  sleep 5
                if curl -s http://localhost:9090/__admin; then
                  echo "Wiremock iniciado correctamente."
                else
                    echo "Error: Wiremock no inició correctamente..."
                    cat wiremock.log
                    exit 1
                fi
            '''

            }
        }

        stage('Tests en paralelo') {
            parallel {
                stage('Tests Unitarios') {
                    agent { label 'agente-build' }
                    steps {
                        sh 'whoami && hostname && pwd'
                        unstash 'workspace-build'
                        sh 'ls -l app/'
                        echo 'Verificamos instalación de pytest...'
                        sh 'pip3 install pytest --break-system-packages || echo "Pytest ya está instalado."'
                        echo 'Ejecutamos tests unitarios...'
                        sh 'PYTHONPATH=. pytest test/unit --junitxml=result.xml || echo "Error en test de servicio."'
                    }
                }

                stage('Tests Service') {
                    agent { label 'agente-deploy' }
                    steps {
                       sh 'whoami && hostname && pwd'
                       unstash 'workspace-build'
                       sh 'ls -l app/'
                       echo 'Verificando Flask antes del test de servicio...'
                       sh 'curl -v http://localhost:5000/ || echo "Flask no disponible antes del test de servicio."'
                       sh 'sleep 5'
                       echo 'verificando instalación de pytest...'
                       sh 'pip3 install pytest --break-system-packages || echo "Pytest ya está instalado."'
                       echo 'Ejecutando test de servicio...'
                       sh 'PYTHONPATH=. pytest test/rest --junitxml=results-service.xml'
                    }
                }
            }
        }

    }

    post {
        always {
            cleanWs()
        }
        failure {
            echo 'El pipeline ha fallado. Revisa los errores.'
        }
    }
}
