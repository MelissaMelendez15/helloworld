pipeline {
    agent any

    stages {
         stage('Instalar dependencias') {
           steps {
                sh 'pip3 install flask pytest requests --break-system-packages'
            }
        }

        stage('Clonar repositorio') {
            steps {
                git branch: 'feature_fix_racecond', url: 'https://github.com/MelissaMelendez15/helloworld.git'
                sh 'ls -la'
            }
        }

        stage('Verificar workspace') {
            steps {
                sh 'echo $WORKSPACE'
            }
        }

        stage('Build') {
            steps {
                echo 'Etapa de build vacia por ahora.'
            }
        }

         stage('Simular Carga del sistema') {
            steps {
                echo 'Simulando carga de CPU...'
                sh '''
                    echo "iniciando carga de CPU"
                    for i in {1..4}; do
                        while :; do :; done &
                    done

                    echo "Carga de CPU iniciada. Esperando 30 segudos..."
                    sleep 30

                    echo "Deteniendo carga de CPU..."
                    pkill -f "while :; do :; done" || echo "No se encontr√≥ proceso de carga"
                    echo "Carga de CPU detenida."
                '''
            }
        }
 
        stage('Iniciar Servicios') {
            steps {
                echo 'Iniciando Flask y Wiremock'
                sh '''
                    PYTHONPATH=. nohup python3 app/api.py & 
                    sleep 5

                    for i in {1..10}; do
                        curl -s http://localhost:5000/ && break || sleep 2
                    done

                    mkdir -p test/wiremock
                    [ ! -f test/wiremock/wiremock-standalone-2.27.2.jar ] && echo "Descargando Wiremock JAR..." && curl -L https://repo1.maven.org/maven2/com/github/tomakehurst/wiremock-standalone/2.27.2/wiremock-standalone-2.27.2.jar -o test/wiremock/wiremock-standalone-2.27.2.jar

                    nohup java -jar test/wiremock/wiremock-standalone-2.27.2.jar --port 9090 --root-dir test/wiremock &
                    sleep 5

                    for i in {1..10}; do
                        curl -s http://localhost:9090/__admin && break || sleep 2
                    done

                '''
            }
        }

        stage('Tests en paralelo') {
            parallel {
                stage('Unit') {
                    steps {
                        sh 'PYTHONPATH=. pytest test/unit --junitxml=result.xml'
                    }
                }

                stage('Service') {
                    steps {
                       sh 'PYTHONPATH=. pytest test/rest --junitxml=results-service.xml'
                    }
                }
            }
        }

        stage('Limpiar') {
            steps {
                echo 'Deteniendo Flask y Wiremock'
                sh '''
                   pkill -f "app/api.py" || echo "Flask ya estaba detenido"
                   pkill -f "wiremock-standalone" || echo "Wiremock ya estaba detenido"
                   pkill -f "while :; do :; done" || echo "Carga ya detenida"

                '''
            }
        }
    }

    post {
        always {
            junit 'results-*.xml'
            cleanWs()
        }
    }
}
